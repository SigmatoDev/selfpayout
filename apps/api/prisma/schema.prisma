generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  RETAILER_ADMIN
  RETAILER_STAFF
}

enum RetailerStatus {
  PENDING_ONBOARDING
  ACTIVE
  SUSPENDED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  UNKNOWN
}

enum PaymentMode {
  CASH
  UPI
  CARD
}

enum StoreType {
  KIRANA
  RESTAURANT
  TRAIN
}

enum StorageProvider {
  LOCAL
  S3
}

enum InvoiceDeliveryChannel {
  PRINT
  WHATSAPP
  PDF
  EMAIL
}

enum SelfCheckoutStatus {
  IN_PROGRESS
  SUBMITTED
  PAID
  APPROVED
  CANCELLED
}

model Retailer {
  id                 String           @id @default(uuid())
  name               String
  shopName           String
  contactEmail       String           @unique
  contactPhone       String
  address            String
  gstEnabled         Boolean          @default(false)
  gstNumber          String?
  languagePreference String           @default("en")
  status             RetailerStatus   @default(PENDING_ONBOARDING)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  subscription       Subscription?
  subscriptionPlanId String?
  kyc                Kyc?
  users              User[]
  inventory          InventoryItem[]
  customers          Customer[]
  invoices           Invoice[]
  payments           Payment[]
  settings           RetailerSettings?
  selfCheckoutSessions SelfCheckoutSession[]
}

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  passwordHash String
  role         UserRole
  retailerId   String?
  retailer     Retailer? @relation(fields: [retailerId], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model SubscriptionPlan {
  id            String           @id @default(uuid())
  name          String
  price         Float
  billingCycle  String
  features      String[]
  active        Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  subscriptions Subscription[]
  payments       Payment[]
}

model Subscription {
  id        String             @id @default(uuid())
  retailer  Retailer           @relation(fields: [retailerId], references: [id])
  retailerId String            @unique
  plan      SubscriptionPlan   @relation(fields: [planId], references: [id])
  planId    String
  startDate DateTime           @default(now())
  endDate   DateTime?
  status    SubscriptionStatus @default(ACTIVE)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
}

model Kyc {
  id               String    @id @default(uuid())
  retailer         Retailer  @relation(fields: [retailerId], references: [id])
  retailerId       String    @unique
  status           String    @default("PENDING")
  documents        Json?
  reviewerComments String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model InventoryItem {
  id           String   @id @default(uuid())
  retailer     Retailer @relation(fields: [retailerId], references: [id])
  retailerId   String
  sku          String
  name         String
  price        Float
  mrp          Float?
  taxPercentage Float   @default(0)
  stockQuantity Int     @default(0)
  unit         String   @default("pcs")
  barcode      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  selfCheckoutItems SelfCheckoutItem[]

  @@unique([retailerId, sku], name: "retailerId_sku")
}

model Customer {
  id            String    @id @default(uuid())
  retailer      Retailer  @relation(fields: [retailerId], references: [id])
  retailerId    String
  name          String
  phone         String
  email         String?
  notes         String?
  balanceAmount Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  invoices      Invoice[]

  @@unique([retailerId, phone], name: "retailerId_phone")
}

model Invoice {
  id            String        @id @default(uuid())
  retailer      Retailer      @relation(fields: [retailerId], references: [id])
  retailerId    String
  customer      Customer?     @relation(fields: [customerId], references: [id])
  customerId    String?
  customerPhone String?
  paymentMode   PaymentMode
  subtotalAmount Float
  taxAmount     Float
  totalAmount   Float
  notes         String?
  selfCheckoutSession SelfCheckoutSession? @relation("SessionInvoice", fields: [selfCheckoutSessionId], references: [id])
  selfCheckoutSessionId String? @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  items         InvoiceItem[]
  deliveryLogs  InvoiceDeliveryLog[]
}

model InvoiceItem {
  id        String   @id @default(uuid())
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
  invoiceId String
  sku       String
  name      String
  quantity  Float
  price     Float
  taxPercentage Float @default(0)
}

model Payment {
  id                    String       @id @default(uuid())
  retailer              Retailer     @relation(fields: [retailerId], references: [id])
  retailerId            String
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])
  planId                String
  amount                Float
  currency              String        @default("INR")
  status                PaymentStatus @default(PENDING)
  razorpayPaymentLinkId String?
  razorpayPaymentId     String?
  referenceId           String?       @unique
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
}

model RetailerSettings {
  id                 String          @id @default(uuid())
  retailer           Retailer        @relation(fields: [retailerId], references: [id])
  retailerId         String          @unique
  storageProvider    StorageProvider @default(LOCAL)
  storageBucket      String?
  storageRegion      String?
  storagePathPrefix  String?         @map("storage_path_prefix")
  offlineModeEnabled Boolean         @default(false)
  supportedLanguages String[]        @default(["en"])
  receiptFooter      String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

model InvoiceDeliveryLog {
  id           String                 @id @default(uuid())
  invoice      Invoice                @relation(fields: [invoiceId], references: [id])
  invoiceId    String
  channel      InvoiceDeliveryChannel
  destination  String?
  status       String                 @default("PENDING")
  payload      Json?
  createdAt    DateTime               @default(now())
  deliveredAt  DateTime?

  @@index([invoiceId])
}

model SelfCheckoutSession {
  id               String              @id @default(uuid())
  retailer         Retailer            @relation(fields: [retailerId], references: [id])
  retailerId       String
  customerPhone    String?
  kioskDeviceId    String?
  status           SelfCheckoutStatus  @default(IN_PROGRESS)
  storeType        StoreType           @default(KIRANA)
  totalAmount      Float               @default(0)
  securityCode     String              @unique
  securityVerifiedAt DateTime?
  notes            String?
  context          Json?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  items            SelfCheckoutItem[]
  invoice          Invoice?            @relation("SessionInvoice")
  securityEvents   SecurityGateEvent[]

  @@index([retailerId])
}

model SelfCheckoutItem {
  id           String                @id @default(uuid())
  session      SelfCheckoutSession   @relation(fields: [sessionId], references: [id])
  sessionId    String
  inventoryItem InventoryItem?       @relation(fields: [inventoryItemId], references: [id])
  inventoryItemId String?
  sku          String
  name         String
  quantity     Float
  price        Float
  taxPercentage Float                @default(0)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  @@index([sessionId])
  @@index([inventoryItemId])
}

model SecurityGateEvent {
  id             String               @id @default(uuid())
  session        SelfCheckoutSession  @relation(fields: [sessionId], references: [id])
  sessionId      String
  guardId        String?
  status         String               @default("PENDING")
  scannedAt      DateTime             @default(now())
  remarks        String?
  attachmentUrl  String?

  @@index([sessionId])
}
